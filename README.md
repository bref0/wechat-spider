# å¾®ä¿¡å…¬ä¼—å·çˆ¬è™« - Node.js TypeScript ç‰ˆæœ¬

åŸºäº TypeScript çš„å¾®ä¿¡å…¬ä¼—å·æ–‡ç« çˆ¬è™«å·¥å…·,æ”¯æŒæœ¬åœ°æ–‡ä»¶å­˜å‚¨å’Œæ•°æ®åº“å­˜å‚¨ä¸¤ç§æ¨¡å¼ã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **TypeScript** - å®Œæ•´çš„ç±»å‹å®‰å…¨
- ğŸ­ **Playwright** - è‡ªåŠ¨ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
- ğŸ“ **åŒå­˜å‚¨æ¨¡å¼** - æœ¬åœ°æ–‡ä»¶ + æ•°æ®åº“(SQLite)
- ğŸ–¼ï¸ **åª’ä½“ä¸‹è½½** - è‡ªåŠ¨ä¸‹è½½å›¾ç‰‡å’Œè§†é¢‘åˆ°æœ¬åœ°
- ğŸ“ **Markdown è½¬æ¢** - æ”¯æŒ HTML â†’ Markdown
- âš™ï¸ **çµæ´»é…ç½®** - JSON5 é…ç½®(æ”¯æŒæ³¨é‡Š) + ç¯å¢ƒå˜é‡
- ğŸ”„ **å¹¶å‘æ§åˆ¶** - é˜²æ­¢è¢«å°ç¦
- ğŸ“Š **CSV å¯¼å‡º** - å…¼å®¹ Python ç‰ˆæœ¬æ ¼å¼

## ğŸ“¦ å®‰è£…

### æ–¹å¼ä¸€: ä¸€é”®å®‰è£… (æ¨è,æ”¯æŒæ‰€æœ‰ç³»ç»Ÿ)

```bash
# å…‹éš†é¡¹ç›®
git clone <é¡¹ç›®åœ°å€>
cd wechat-spider-node

# å®‰è£… pnpm (å¦‚æœæœªå®‰è£…)
npm install -g pnpm

# ä¸€é”®åˆå§‹åŒ– (è‡ªåŠ¨å®‰è£…ä¾èµ–ã€ç”Ÿæˆæ•°æ®åº“ã€æ£€æŸ¥é…ç½®)
pnpm setup
```

**æ”¯æŒç³»ç»Ÿ:** âœ… Windows | âœ… macOS | âœ… Linux

**è¯´æ˜:** config.json å·²åŒ…å«åœ¨ä»“åº“ä¸­(å¸¦å®Œæ•´æ³¨é‡Š),æ— éœ€æ‰‹åŠ¨åˆ›å»º!

### æ–¹å¼äºŒ: æ‰‹åŠ¨å®‰è£…

```bash
# å®‰è£…ä¾èµ–
pnpm install

# åˆå§‹åŒ–æ•°æ®åº“
pnpm db:generate

# å¤åˆ¶ .env æ–‡ä»¶ (å¯é€‰)
cp .env.example .env              # Windows: copy .env.example .env
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€: äº¤äº’å¼èœå• (æ¨èæ–°æ‰‹)

ç›´æ¥è¿è¡Œä¸»ç¨‹åº,é€šè¿‡èœå•é€‰æ‹©æ“ä½œ:

```bash
pnpm dev
```

ä¼šå‡ºç°äº¤äº’å¼èœå•:

```
ğŸš€ æ¬¢è¿ä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·çˆ¬è™«å·¥å…·

? è¯·é€‰æ‹©æ“ä½œ: (Use arrow keys)
â¯ âš™ï¸  é…ç½®å‘å¯¼ - ç”Ÿæˆ/ä¿®æ”¹ config.json
  ğŸ” ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
  ğŸ“„ çˆ¬å–å•ä¸ªå…¬ä¼—å·
  ğŸ“š æ‰¹é‡çˆ¬å–å¤šä¸ªå…¬ä¼—å·
  âŒ é€€å‡º
```

#### 1. é…ç½®å‘å¯¼

é€‰æ‹© `é…ç½®å‘å¯¼` åä¼šå¼•å¯¼ä½ å®Œæˆæ‰€æœ‰é…ç½®é¡¹(å­˜å‚¨æ¨¡å¼ã€åª’ä½“ä¸‹è½½ã€çˆ¬è™«å‚æ•°ç­‰),è‡ªåŠ¨ç”Ÿæˆ `config.json`ã€‚

#### 2. ç™»å½•

é€‰æ‹© `ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°`,ä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨,æ‰«ç ç™»å½•åä¿å­˜ Token å’Œ Cookie(é»˜è®¤æœ‰æ•ˆæœŸ 4 å¤©)ã€‚

#### 3. çˆ¬å–å•ä¸ªå…¬ä¼—å·

é€‰æ‹© `çˆ¬å–å•ä¸ªå…¬ä¼—å·` å:
- å¯é€‰æ‹©ä½¿ç”¨é»˜è®¤é…ç½®æˆ–è‡ªå®šä¹‰å‚æ•°(å¤©æ•°/æ•°é‡/é¡µæ•°/æ—¥æœŸèŒƒå›´/å…¨éƒ¨)
- è¾“å…¥å…¬ä¼—å·åç§°å³å¯å¼€å§‹çˆ¬å–

#### 4. æ‰¹é‡çˆ¬å–

é€‰æ‹© `æ‰¹é‡çˆ¬å–å¤šä¸ªå…¬ä¼—å·` å:
- å¯ä½¿ç”¨ config.json ä¸­çš„åˆ—è¡¨,æˆ–æ‰‹åŠ¨è¾“å…¥å¤šä¸ªå…¬ä¼—å·
- æ”¯æŒè‡ªå®šä¹‰å‚æ•°å’Œè´¦å·é—´éš”

### æ–¹å¼äºŒ: å‘½ä»¤è¡Œæ¨¡å¼ (é€‚åˆè„šæœ¬åŒ–)

#### 1. é…ç½®å‘å¯¼

```bash
pnpm dev init
```

#### 2. ç™»å½•

```bash
pnpm spider:login
```

#### 3. çˆ¬å–å•ä¸ªå…¬ä¼—å·

```bash
pnpm dev scrape "è…¾è®¯ç§‘æŠ€" --days 30 --skip-existing
```

#### 4. æ‰¹é‡çˆ¬å–

```bash
pnpm dev batch
```

ä» config.json è¯»å–å…¬ä¼—å·åˆ—è¡¨æ‰¹é‡çˆ¬å–ã€‚

#### 5. å¯¼å‡º CSV

```bash
pnpm dev export "è…¾è®¯ç§‘æŠ€" -o ./exports/tencent.csv
```

## ğŸ“– ä½¿ç”¨æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **äº¤äº’å¼èœå•** (`pnpm dev`) | æ–°æ‰‹ã€ä¸´æ—¶ä½¿ç”¨ | æ— éœ€è®°å‘½ä»¤,å¼•å¯¼å¼æ“ä½œ | ä¸é€‚åˆè‡ªåŠ¨åŒ– |
| **å‘½ä»¤è¡Œ** (`pnpm dev scrape`) | ç†Ÿç»ƒç”¨æˆ·ã€è„šæœ¬åŒ– | çµæ´»ã€å¯è‡ªåŠ¨åŒ– | éœ€è¦è®°ä½å‚æ•° |

## ğŸ“– å‘½ä»¤è¡Œæ¨¡å¼è¯¦è§£

> å¦‚æœä½ æ›´å–œæ¬¢äº¤äº’å¼,ç›´æ¥è¿è¡Œ `pnpm dev` å³å¯,æ— éœ€è®°ä»¥ä¸‹å‘½ä»¤ã€‚

### é…ç½®å‘å¯¼
```bash
pnpm dev init
```

äº¤äº’å¼ç”Ÿæˆ config.json,åŒ…å«æ‰€æœ‰é…ç½®é¡¹ã€‚

### ç™»å½•
```bash
pnpm spider:login
```

### æœç´¢å…¬ä¼—å·
```bash
pnpm dev search <å…¬ä¼—å·åç§°>
```

### çˆ¬å–æ–‡ç« 
```bash
pnpm dev scrape <å…¬ä¼—å·åç§°> [é€‰é¡¹]

é€‰é¡¹:
  -p, --pages <number>   æœ€å¤§çˆ¬å–é¡µæ•°
  -d, --days <number>    çˆ¬å–æœ€è¿‘å‡ å¤©çš„æ–‡ç« 
  -l, --limit <number>   é™åˆ¶æ–‡ç« æ•°é‡
  --start-date <date>    å¼€å§‹æ—¥æœŸ (YYYY-MM-DD)
  --end-date <date>      ç»“æŸæ—¥æœŸ (YYYY-MM-DD)
  --all                  çˆ¬å–æ‰€æœ‰æ–‡ç« 
  --skip-existing        è·³è¿‡å·²å­˜åœ¨çš„æ–‡ç« 
```

**å‚æ•°ä¼˜å…ˆçº§è¯´æ˜:**
- æ—¶é—´è¿‡æ»¤ (--days/--start-date) ä¼˜å…ˆçº§**æœ€é«˜**,é‡åˆ°è¶…æœŸæ–‡ç« ä¼šç›´æ¥åœæ­¢çˆ¬å–
- æ•°é‡é™åˆ¶ (--limit) å…¶æ¬¡,è¾¾åˆ°æ•°é‡ååœæ­¢
- é¡µæ•°é™åˆ¶ (--pages) æ˜¯ä¿æŠ¤ä¸Šé™,é˜²æ­¢æ— é™çˆ¬å–

ç¤ºä¾‹:
```bash
# çˆ¬å–æœ€è¿‘ 7 å¤©çš„æ–‡ç« 
pnpm dev scrape "è…¾è®¯ç§‘æŠ€" --days 7

# çˆ¬å–å‰ 50 ç¯‡æ–‡ç« 
pnpm dev scrape "36æ°ª" --limit 50

# è·³è¿‡å·²çˆ¬å–çš„æ–‡ç« 
pnpm dev scrape "æ–°æµªç§‘æŠ€" --skip-existing
```

### æ‰¹é‡çˆ¬å–

```bash
pnpm dev batch
```

ä» `config.json` è¯»å–å…¬ä¼—å·åˆ—è¡¨:
```json
{
  "batch": {
    "accounts": [
      "è…¾è®¯ç§‘æŠ€",
      "36æ°ª",
      "æ–°æµªç§‘æŠ€"
    ],
    "accountInterval": 10
  }
}
```

ä½¿ç”¨ç¤ºä¾‹:
```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰è®¾ç½®
pnpm dev batch

# è‡ªå®šä¹‰å‚æ•°
pnpm dev batch --mode database --limit 10 --skip-existing
```

### å¯¼å‡º CSV
```bash
pnpm dev export <å…¬ä¼—å·åç§°> [é€‰é¡¹]

é€‰é¡¹:
  -o, --output <path>    è¾“å‡ºæ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./<å…¬ä¼—å·åç§°>.csv)
```

## âš™ï¸ é…ç½®è¯´æ˜

### config.json

é…ç½®æ–‡ä»¶æ”¯æŒ JSON5 æ ¼å¼,å¯ä»¥æ·»åŠ æ³¨é‡Šã€‚

é…ç½®ç¤ºä¾‹ (æ”¯æŒ `//` æ³¨é‡Š):

```json5
{
  "storage": {
    "mode": "local",                    // å­˜å‚¨æ¨¡å¼
    "local": {
      "baseDir": "./output",            // è¾“å‡ºç›®å½•
      "folderNameTemplate": "{title}_{date}",  // æ–‡ä»¶å¤¹å‘½åè§„åˆ™
      "downloadMedia": true,            // æ˜¯å¦ä¸‹è½½å›¾ç‰‡/è§†é¢‘
      "saveAs": "markdown",             // ä¿å­˜æ ¼å¼: markdown | html
      "includeMetadata": true           // æ˜¯å¦ä¿å­˜å…ƒæ•°æ® JSON
    },
    "database": {
      "type": "sqlite",
      "saveMediaUrls": true,            // ä¿å­˜åª’ä½“é“¾æ¥
      "downloadMedia": false            // æ˜¯å¦åŒæ—¶ä¸‹è½½åˆ°æœ¬åœ°
    }
  },
  "media": {
    "download": {
      "images": true,
      "videos": true,
      "timeout": 30000,                 // ä¸‹è½½è¶…æ—¶(ms)
      "retryTimes": 3,                  // é‡è¯•æ¬¡æ•°
      "concurrent": 5                   // å¹¶å‘ä¸‹è½½æ•°
    }
  },
  "scraper": {
    "requestInterval": 10,              // è¯·æ±‚é—´éš”(ç§’)
    "maxPages": 10,
    "days": 30
  }
}
```

### .env

```bash
DATABASE_URL="file:./data/wechat.db"
WECHAT_CACHE_FILE="wechat_cache.json"
WECHAT_CACHE_EXPIRE_HOURS=96
STORAGE_MODE="local"
LOG_LEVEL="info"
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
wechat-spider-node/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ wechat/          # å¾®ä¿¡çˆ¬è™«æ ¸å¿ƒ
â”‚   â”œâ”€â”€ storage/         # å­˜å‚¨æ¨¡å—(æœ¬åœ°æ–‡ä»¶ + æ•°æ®åº“)
â”‚   â”œâ”€â”€ media/           # å›¾ç‰‡/è§†é¢‘ä¸‹è½½
â”‚   â”œâ”€â”€ logger/          # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ cli/             # CLI å·¥å…·
â”‚   â””â”€â”€ types/           # ç±»å‹å®šä¹‰
â”œâ”€â”€ prisma/              # æ•°æ®åº“æ¨¡å‹
â”œâ”€â”€ output/              # æœ¬åœ°æ–‡ä»¶è¾“å‡ºç›®å½•
â”œâ”€â”€ data/                # æ•°æ®åº“æ–‡ä»¶
â””â”€â”€ logs/                # æ—¥å¿—æ–‡ä»¶
```

## ğŸ”§ å¼€å‘

```bash
# å¼€å‘æ¨¡å¼(çƒ­é‡è½½)
pnpm dev <command>

# ç±»å‹æ£€æŸ¥
pnpm type-check

# æ„å»º
pnpm build

# è¿è¡Œæ„å»ºåçš„ç‰ˆæœ¬
pnpm start

# æŸ¥çœ‹æ•°æ®åº“
pnpm db:studio
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¯·æ±‚é—´éš”**: å»ºè®®è®¾ç½®åˆç†çš„è¯·æ±‚é—´éš”(é»˜è®¤ 10 ç§’),é¿å…è¢«å¾®ä¿¡é™åˆ¶
2. **ç™»å½•ç¼“å­˜**: Token é»˜è®¤æœ‰æ•ˆæœŸ 4 å¤©,è¿‡æœŸåéœ€è¦é‡æ–°ç™»å½•
3. **æ–‡ä»¶å¤¹å‘½å**: ä¼šè‡ªåŠ¨æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
4. **åª’ä½“ä¸‹è½½**: å¤§é‡ä¸‹è½½å¯èƒ½è€—æ—¶è¾ƒé•¿,å¯ä»¥å…ˆç”¨ `--no-media` æµ‹è¯•
5. **æ•°æ®åº“**: SQLite é€‚åˆå•æœºä½¿ç”¨,å¦‚éœ€å¤šæœåŠ¡å™¨å…±äº«å¯åˆ‡æ¢åˆ° MySQL

## ğŸ“Š å­˜å‚¨æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **local** | å®Œæ•´ç¦»çº¿å½’æ¡£,æ–¹ä¾¿åˆ†äº« | æ— æ³•æŸ¥è¯¢,å¤§é‡æ–‡ä»¶ç®¡ç†å›°éš¾ | ä¸ªäººçŸ¥è¯†åº“,åšå®¢å¤‡ä»½ |
| **database** | é«˜æ•ˆæŸ¥è¯¢,å»é‡,åˆ†æ | éœ€è¦å·¥å…·æŸ¥çœ‹ | æ•°æ®åˆ†æ,æœç´¢å¼•æ“ |
| **both** | ä¸¤è€…ä¼˜ç‚¹éƒ½æœ‰ | å ç”¨ç©ºé—´å¤§ | é‡è¦å†…å®¹å½’æ¡£ |

## ğŸ“ License

MIT

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®æ˜¯ [WeMediaSpider](../WeMediaSpider) Python ç‰ˆæœ¬çš„ Node.js é‡æ„ç‰ˆæœ¬ã€‚
